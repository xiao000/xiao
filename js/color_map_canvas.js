var colorData={"1":{name:"艳红",pinyin:"YANHONG"},"2":{name:"猩红",pinyin:"XINGHONG"},"3":{name:"绛紫",pinyin:"JIANGZI"},"4":{name:"银朱",pinyin:"YINZHU"},"5":{name:"浅血牙",pinyin:"QIANXUEYA"},"6":{name:"月季红",pinyin:"YUEJIHONG"},"7":{name:"玫瑰红",pinyin:"MEIGUIHONG"},"8":{name:"枣红",pinyin:"ZAOHONG"},"9":{name:"洋红",pinyin:"YANGHONG"},"10":{name:"紫粉",pinyin:"ZIFEN"},"11":{name:"茄皮紫",pinyin:"QIEPIZI"},"12":{name:"深烟红",pinyin:"SHENYANHONG"},"13":{name:"雪紫",pinyin:"XUEZI"},"14":{name:"玫瑰灰",pinyin:"MEIGUIHUI"},"15":{name:"洋葱紫",pinyin:"YANGCONGZI"},"16":{name:"元青",pinyin:"YUANQING"},"17":{name:"品红",pinyin:"PINHONG"},"18":{name:"紫薇花",pinyin:"ZIWEIHUA"},"19":{name:"牵牛紫",pinyin:"QIANNIUZI"},"20":{name:"紫水晶",pinyin:"ZISHUIJING"},"21":{name:"浅石英紫",pinyin:"QIANSHIYINGZI"},"22":{name:"柏坊灰蓝",pinyin:"BAIFANGHUILAN"},"23":{name:"紫藤灰",pinyin:"ZITENGHUI"},"24":{name:"浅藤紫",pinyin:"QIANTENGZI"},"25":{name:"宝蓝",pinyin:"BAOLAN"},"26":{name:"靛蓝",pinyin:"DIANLAN"},"27":{name:"藏蓝",pinyin:"ZANGLAN"},"28":{name:"粗晶皂",pinyin:"CUJINGZAO"},"29":{name:"孔雀蓝",pinyin:"KONGQUELAN"},"30":{name:"浅海昌蓝",pinyin:"QIANHAICHANGLAN"},"31":{name:"花青",pinyin:"HUAQING"},"32":{name:"鹊灰",pinyin:"QUEHUI"},"33":{name:"海蓝",pinyin:"HAILAN"},"34":{name:"黛蓝",pinyin:"DAILAN"},"35":{name:"深竹月",pinyin:"SHENZHUYUE"},"36":{name:"绒蓝",pinyin:"RONGLAN"},"37":{name:"北京毛蓝",pinyin:"BEIJINGMAOLAN"},"38":{name:"沙青",pinyin:"SHAQING"},"39":{name:"钴蓝",pinyin:"GULAN"},"40":{name:"铁灰",pinyin:"TIEHUI"},"41":{name:"红皂",pinyin:"HONGZAO"},"42":{name:"正灰",pinyin:"ZHENGHUI"},"43":{name:"玉石蓝",pinyin:"YUSHILAN"},"44":{name:"天青*",pinyin:"TIANQING"},"45":{name:"灰蓝",pinyin:"HUILAN"},"46":{name:"春蓝",pinyin:"CHUNLAN"},"47":{name:"织锦灰",pinyin:"ZHIJINHUI"},"48":{name:"碧玉石",pinyin:"BIYUSHI"},"49":{name:"沙绿",pinyin:"SHALV"},"50":{name:"灰绿",pinyin:"HUILV"},"51":{name:"翠绿",pinyin:"CUILV"},"52":{name:"卡其绿",pinyin:"KAQILV"},"53":{name:"果灰",pinyin:"GUOHUI"},"54":{name:"鹦鹉绿",pinyin:"YINGWULV"},"55":{name:"鸭蛋青",pinyin:"YADANQING"},"56":{name:"三绿",pinyin:"SANLV"},"57":{name:"承德皂",pinyin:"CHENGDEZAO"},"58":{name:"老绿",pinyin:"LAOLV"},"59":{name:"奶绿",pinyin:"NAILV"},"60":{name:"淡灰绿",pinyin:"DANHUILV"},"61":{name:"水貂灰",pinyin:"SHUIDIAOHUI"},"62":{name:"油绿",pinyin:"YOULV"},"63":{name:"锈绿",pinyin:"XIULV"},"64":{name:"水黄",pinyin:"SHUIHUANG"},"65":{name:"银箔",pinyin:"YINBO"},"66":{name:"苍绿",pinyin:"CANGLV"},"67":{name:"黄灰",pinyin:"HUANGHUI"},"68":{name:"春绿",pinyin:"CHUNLV"},"69":{name:"军绿",pinyin:"JUNLV"},"70":{name:"大赤金",pinyin:"DACHIJIN"},"71":{name:"芦灰",pinyin:"LUHUI"},"72":{name:"米色",pinyin:"MISE"},"73":{name:"油烟墨",pinyin:"YOUYANMO"},"74":{name:"承德灰",pinyin:"CHENGDEHUI"},"75":{name:"橄榄绿",pinyin:"GANLANLV"},"76":{name:"枯绿",pinyin:"KULV"},"77":{name:"柠檬黄",pinyin:"NINGMENGHUANG"},"78":{name:"蜡白",pinyin:"LABAI"},"79":{name:"草黄",pinyin:"CAOHUANG"},"80":{name:"灰米",pinyin:"HUIMI"},"81":{name:"藤黄",pinyin:"TENGHUANG"},"82":{name:"胡粉",pinyin:"HUFEN"},"83":{name:"丹东石",pinyin:"DANDONGSHI"},"84":{name:"库金",pinyin:"KUJIN"},"85":{name:"甘草黄",pinyin:"GANCAOHUANG"},"86":{name:"灯草灰",pinyin:"DENGCAOHUI"},"87":{name:"米灰",pinyin:"MIHUI"},"88":{name:"姜黄",pinyin:"JIANGHUANG"},"89":{name:"选金",pinyin:"XUANJIN"},"90":{name:"浅棕灰",pinyin:"QIANZONGHUI"},"91":{name:"将校呢",pinyin:"JIANGXIAONI"},"92":{name:"卡其黄",pinyin:"KAQIHUANG"},"93":{name:"相思灰",pinyin:"XIANGSIHUI"},"94":{name:"枝黄",pinyin:"ZHIHUANG"},"95":{name:"中棕灰",pinyin:"ZHONGZONGHUI"},"96":{name:"土黄",pinyin:"TUHUANG"},"97":{name:"浅驼色",pinyin:"QIANTUOSE"},"98":{name:"棕茶",pinyin:"ZONGCHA"},"99":{name:"雄黄",pinyin:"XIONGHUANG"},"100":{name:"纸棕",pinyin:"ZHIZONG"},"101":{name:"浅桔黄",pinyin:"QIANJUHUANG"},"102":{name:"浅黄棕",pinyin:"QIANHUANGZONG"},"103":{name:"金黄",pinyin:"JINHUANG"},"104":{name:"米红",pinyin:"MIHONG"},"105":{name:"桔黄",pinyin:"JUHUANG"},"106":{name:"苍黄",pinyin:"CANGHUANG"},"107":{name:"雄精",pinyin:"XIONGJING"},"108":{name:"甘石粉",pinyin:"GANSHIFEN"},"109":{name:"章丹",pinyin:"ZHANGDAN"},"110":{name:"桔红",pinyin:"JUHONG"},"111":{name:"奶棕",pinyin:"NAIZONG"},"112":{name:"血红",pinyin:"XUEHONG"},"113":{name:"辰砂",pinyin:"CHENSHA"},"114":{name:"十样锦",pinyin:"SHIYANGJIN"},"115":{name:"番茄红",pinyin:"FANQIEHONG"},"116":{name:"榴花红",pinyin:"LIUHUAHONG"},"117":{name:"胭脂",pinyin:"YANZHI"},"118":{name:"妃红",pinyin:"FEIHONG"},"119":{name:"锈红",pinyin:"XIUHONG"},"120":{name:"深烟",pinyin:"SHENYAN"},"121":{name:"雪色",pinyin:"XUESE"},"122":{name:"百草霜",pinyin:"BAICAOSHUANG"}};


var closeTimer = null;
hideHeader(10);
$("#close").click(function(){
  $("#header_remind").addClass("header_hide");
});
$("#header_remind").hover(
  function(){
    clearTimeout(closeTimer);
  },
  function(){
    hideHeader(10);
});
function hideHeader(time){
  closeTimer = setTimeout(function(){
    $("#header_remind").addClass("header_hide");
  },time*1000);
};
var colorMap={
  LocatCMYK:[{x:14,y:30},{x:14,y:60},{x:14,y:90},{x:14,y:120}],//LocatCMYK四个圆环的圆心位置
  LocatRGB:[18,23,28],//记录三条直线的起点的X坐标
  LocatRGBY:148,//记录三条直线的起点的Y坐标
  LINEBACKLENGTH:122,//背景线的长度
  BACKSTYLE:'rgba(223,233,234,0.5)',//canvas中背景圆环和直线的颜色
  FONTSTYLE:'#fff',//canvas中圆环和直线的前景色
  FONTSTARTANGLE:-Math.PI/2,//canvas中前面圆环绘制时的起始角度
  LINTWIDTH:2.2,//canvas直线线宽
  CIRCLEWIDTH:6,//canvas圆环线宽
  CIRCLERadius:10,//canvas圆环半径
  rgbs:[],//保存各颜色的十进制rgb颜色值
  timer:null,//定时器
  lastClickIndex:-1,//用于判断前后两次点击是否是同一个li,不能为0，否则第一个li无法点击

  //AnimateCMYK相关参数
  animateCMYK:[{x:30,y:50},{x:30,y:140},{x:30,y:230},{x:30,y:320}],//AnimateCMYK四个圆环的圆心位置
  offsetText:{'x':-30,'y':-30},//CMYK文本相对于圆心的偏移位置
  AM_TEXT:['C','M','Y','K'],
  AM_CIRCLEWIDTH:4,//圆环线宽
  AM_NUMBERWIDTH:2.2,//数字文本线宽
  //AM_CMYKWIDTH:6,//CMYK文本线宽
  AM_COLOR:['#eee','#6f93d8','#9a3','#f93'],
  AM_DIVIDER:'#CCC',
  AM_CIRCLERadius:24,//canvas圆环半径
  AM_CIRCLECOLOR:'rgba(211,211,211,.5)',
  $canvas:$("#animateCanvas"),
  valueOfCMYK:[],
  cValue:[],//means currentValueOfCMYK. too loog!
  stepTime:50,

  //*********************初始化***************************//
  init:function(){
    this.drawList();
    var context = this.$canvas[0].getContext('2d');
    //绘制右侧动态展示的CMYK canvas画布,不需要等待DOM树加载完成
    this.valueOfCMYK.push([0,96,51,75]);
    this.cValue = this.valueOfCMYK[0];
    this.drawAnimateCanvas(context,this.valueOfCMYK[0]);

    var that = this;
    //初始化RGB的数字显示
    var rgbInit=[10,120,60];
    $("#rgb_list>li").each(function(i){
      var $thisLi = $(this);
      that.animate_RGB($thisLi,rgbInit[i]);//设置$thisLi下的span的marginTop = -rgb.x...
    });
    //为color_map里的li绑定单击事件
    //暂未添加处理动画叠加的方法
    $("#color_list").on("click","li>a",function(e){
      e.preventDefault();
      var $index = $(this).parent().index();
      //本次动画未完成，不执行点击事件的处理函数
      if(that.timer==null && $index!=that.lastClickIndex){
        var $colorName = $("#color_name");
        //不够优雅？
        $colorName.children().addClass("animating");
        var cc = $index+1+'';
        var $cname = colorData[cc];
        that.time = 0;
        //非Interval动画
        //无法取得rgbs中存储的颜色值=>问题所在，归根结底为this的指向问题
        var rgb = that.rgbs[cc];
        document.querySelector("body").style.backgroundColor = `rgba(${rgb.r},${rgb.g},${rgb.b},1)`;
        // 循环ul>li 传入rgbIndex[],修改margin-top值
        $("#rgb_list>li").each(function(){
          var $thisLi = $(this);
          var rgbI = $thisLi.data('rgb');
          that.animate_RGB($thisLi,rgb[rgbI]);//设置$thisLi下的span的marginTop = -rgb.x...
        });
        // canvas绘制CMYK动画绘制前计算步长
        var stepCMYK = [];
        var value=[];//为了不污染that.cValue,让cValue作用单一化，新定义一个局部变量

        for(let i=0;i<4;i++){
          stepCMYK[i] = (that.valueOfCMYK[cc][i] - that.cValue[i])/2000*that.stepTime;
          value[i] = that.cValue[i];
        }
        //Interval动画
        that.timer = setInterval(function(){
          // 标题汉字及拼音的淡入淡出及文字切换动画
          if(that.time>=(1000-that.stepTime)){
            $colorName.children('h2').html($cname.name);
            $colorName.children('p').html($cname.pinyin);
            if(that.time>=2000){
              $colorName.children().removeClass("animating");
              clearInterval(that.timer);
              that.timer=null;

            }
          }
          // canvas绘制CMYK动画
          for(let i=0;i<4;i++){
            value[i] += stepCMYK[i];
            //保存变量that.valueOfCMYK[cc]
            let ck = that.valueOfCMYK[cc][i];
            if(stepCMYK[i]<0){
              if(value[i]<=ck){
                value[i]=ck;
              }
            }else{
              if(value[i]>=ck){
                value[i]=ck;
              }
            }
          }
          that.drawAnimateCanvas(context,value);

          that.time += that.stepTime;
        },that.stepTime);
        that.lastClickIndex = cc-1;//保存本次点击的li元素的索引
        // 保存本次点击时对应的CMYK值
        for(let i=0;i<4;i++){
          that.cValue[i]=that.valueOfCMYK[cc][i];
        }
      }
    });
  },
  //***********************RGB动画效果***************************/
  animate_RGB:function($li,oneOfRGB){
    var splitRGB = [];
    splitRGB.push(parseInt(oneOfRGB/100));
    splitRGB.push(parseInt(oneOfRGB%100/10));
    splitRGB.push(parseInt(oneOfRGB%10));
    // 注意rgb颜色值的百位数字是从1开始的，因此在设置margin-top时要相应的+1 
    $li.find('.left').css('margin-top',-splitRGB[0]+1+'em');
    $li.find('.middle').css('margin-top',-splitRGB[1]+'em');
    $li.find('.right').css('margin-top',-splitRGB[2]+'em');
    if(oneOfRGB<100){
      // $li.find('.left').css('margin-top','1em');
      if(oneOfRGB<10){
        $li.find('.middle').css('margin-top','1em');
      }
    }
  },
  //*********************从数据库获得数据，循环绘制ul li 列表。************************//
  drawList:function(){
    var that =this;
    // 访问数据库，获得数据数组
    $.get("data/showColorList.php",function(datas){
      let rgb =[];
      let html='';
      let rgbFF = [];//保存16进制RGB
      for(let i=0;i<datas.length;i++){
        let data=datas[i];//数据库中各颜色的数据,colorid,c,m,y,k
        let cdata=colorData[data.colorid];//color_base里各颜色的数据，name,pinyin
        // 存储cmyk的值(*********未考虑关联数组，可能存在风险*********)
        that.valueOfCMYK.push([parseInt(data.c),parseInt(data.m),parseInt(data.y),parseInt(data.k)]);
        //将cmyk颜色转化为rgb颜色
        rgb = that.rgbs[''+data.colorid] = that.toRGB(data.c,data.m,data.y,data.k);
        //将RGB转化为16进制，ES6解构赋值用于接收函数返回值
        [rgbFF.r,rgbFF.g,rgbFF.b] = that.toRGBFF(rgb);
        //每次循环绘制一个li元素
        html += that.createLi(cdata,rgbFF);//返回字符串拼接到html上
      }
      $('#color_list').html(html);
      //DOM树生成之后再进行canvas绘图
      that.drawCanvas(datas,that.rgbs);//传入含有cmyk的对象datas;传入含有10进制rgb颜色的rgbs对象数组

    });
  },
  //*********************绘制右侧动态变化的canvas画布***************************//
  drawAnimateCanvas:function(ctx,values){//value为CMYK的值，范围0~100
    ctx.clearRect(0,0,60,360);
    let numText=0;
    for(let i=0;i<4;i++){
      let edeg = values[i]/50*Math.PI + this.FONTSTARTANGLE; //原始公式 dataArr[i]/100*2*Math.PI + this.FONTSTARTANGLE;
      c = this.animateCMYK[i];
      //绘制底层圆环
      ctx.lineWidth = this.AM_CIRCLEWIDTH+1;
      this.drawCircle(ctx,this.AM_CIRCLECOLOR,c,0,2*Math.PI,this.AM_CIRCLERadius);
      //绘制上层圆环
      ctx.lineWidth = this.AM_CIRCLEWIDTH;
      this.drawCircle(ctx,this.AM_COLOR[i],c,this.FONTSTARTANGLE,edeg,this.AM_CIRCLERadius);
      //绘制文字
      ctx.fillStyle = this.FONTSTYLE;
      ctx.font = '18px bold';
      ctx.fillText(this.AM_TEXT[i], c.x + this.offsetText.x, c.y+this.offsetText.y);
      ctx.fillStyle = this.AM_COLOR[i];

      ctx.save();
      ctx.translate(30,45+90*i);
      ctx.font = '22px bold';
      numText = parseInt(values[i]);
      ctx.fillText(numText, -ctx.measureText(numText).width/2,13);
      ctx.restore();
    }
  },
  //*********************在ul li 下的canvas画布上绘值cmyk的圆和rgb的线条***********//
  drawCanvas:function(datas,rgbs){
    var canvas=document.querySelectorAll("#color_list canvas");
    //数组canvas的成员cvs与datas中的对象data一一对应，可以由canvas数组的索引来对应datas中的值
    var cvs=null,ctx=null;
    var data=null,rgb=null;
    var dataArr=null,rgbArr=null;
    for(let cv=0;cv<canvas.length;cv++){
      cvs=canvas[cv];
      data=datas[cv];
      rgb=rgbs[data.colorid];
      dataArr = [data.c,data.m,data.y,data.k];
      rgbArr = [rgb.r,rgb.g,rgb.b];
      ctx=cvs.getContext('2d');
      ctx.lineWidth = this.CIRCLEWIDTH;
      for(let i=0,c=null;i<this.LocatCMYK.length;i++){
        let endAngle = dataArr[i]/50*Math.PI + this.FONTSTARTANGLE; //原始公式 dataArr[i]/100*2*Math.PI + this.FONTSTARTANGLE;
        c=this.LocatCMYK[i];//圆心位置
        this.drawCircle(ctx,this.BACKSTYLE,c,0,2*Math.PI,this.CIRCLERadius);
        this.drawCircle(ctx,this.FONTSTYLE,c,this.FONTSTARTANGLE,endAngle,this.CIRCLERadius);
      }
      ctx.lineWidth=this.LINTWIDTH;
      for(let i=0,c=0;i<3;i++){
        let len = Math.round(rgbArr[i]/255*this.LINEBACKLENGTH);
        c=this.LocatRGB[i];
        this.drawLine(ctx,this.BACKSTYLE,c,this.LINEBACKLENGTH);
        this.drawLine(ctx,this.FONTSTYLE,c,len);
      }
    }

  },
  //*************************生产li元素,li元素的border颜色及其中span.name的颜色写为了内置样式
  createLi:function(cdata,rgb){
    let rgbTXT = rgb.r+rgb.g+rgb.b;
    return `<li class="li_container" style="border-color: #${rgbTXT}">
              <a href="#">
                <span class="name" style="color: #${rgbTXT}">${cdata.name}</span>
                <span class="pinyin">${cdata.pinyin}</span>
                <span class="rgb">${rgbTXT}</span>
                <canvas width="50" height="278" ></canvas>
              </a>
				    </li>`;
  },

  //*****************几个辅助用的封装函数************************//
  //绘制圆环
  drawCircle:function(ctx,style,c,sdeg,edeg,r){
    ctx.strokeStyle = style;
    ctx.beginPath();
    ctx.arc(c.x,c.y,r,sdeg,edeg);
    ctx.stroke();
  },
  //绘制线条
  drawLine:function(ctx,style,x,len){
    ctx.strokeStyle = style;
    ctx.beginPath();
    ctx.moveTo(x,this.LocatRGBY);
    ctx.lineTo(x,this.LocatRGBY+len);
    ctx.stroke();
  },
  //rgb颜色由十进制转化为十六进制
  toRGBFF:function(rgb){
    let r = rgb.r.toString(16);
    let g = rgb.g.toString(16);
    let b = rgb.b.toString(16);
    r = r <= "0F" ? ('0'+ r) : r;
    g = g <= '0F' ? ('0'+ g) : g;
    b = b <= '0F' ? ('0'+ b) : b;
    return [r.toUpperCase(),g.toUpperCase(),b.toUpperCase()];
  },
  //将cmyk颜色转化为rgb颜色
  toRGB: function(c,m,y,k){
    let r = this.cTransfer(c,k);
    let g = this.cTransfer(m,k);
    let b = this.cTransfer(y,k);
    return {'r':r,'g':g,'b':b};
  },
  //将cmyk颜色转化为rgb颜色通用公式
  cTransfer: function (c1,c2){
    let c = Math.round(255*(100-c1)*(100-c2)/10000);
    c= c>=255 ? 255 :c;
    c= c<=0 ? 0 : c;
    return c;
  }
};
colorMap.init();